#!/usr/bin/perl
#
# Write and maintain shaarli configuration file
#

use strict;
use warnings;

use Digest::SHA1 qw( sha1_hex );
use UBOS::Utils  qw( saveFile slurpFile );
use POSIX;

my $dir      = $config->getResolve( 'appconfig.apache2.dir' );
my $dataDir  = "$dir/data";
my $confFile = "$dataDir/config.php";

my $apacheUname = $config->getResolve( 'apache2.uname' );
my $apacheGname = $config->getResolve( 'apache2.gname' );

if( 'deploy' eq $operation ) {
    my $login    = $config->getResolve( 'site.admin.userid' );
    my $password = $config->getResolve( 'site.admin.credential' );
    my $title    = $config->getResolve( 'installable.customizationpoints.title.value' );
    my $timezone = $config->getResolve( 'installable.customizationpoints.timezone.value' );
    my $salt     = UBOS::Utils::randomHex( 40 );
    my $hash     = sha1_hex( $password . $login . $salt );
    
    my $confContent = <<END;
<?php

// Generated by package shaarli

\$GLOBALS['login']='$login';
\$GLOBALS['hash']='$hash';
\$GLOBALS['salt']='$salt';
\$GLOBALS['timezone']='$timezone';
date_default_timezone_set(\$GLOBALS['timezone']);
\$GLOBALS['title']='$title';
\$GLOBALS['redirector']='';
\$GLOBALS['disablesessionprotection']=false;
\$GLOBALS['disablejquery']=false;
\$GLOBALS['privateLinkByDefault']=false;

?>
END

    UBOS::Utils::saveFile( $confFile, $confContent, 0644, $apacheUname, $apacheGname );
}

if( 'undeploy' eq $operation ) {
    if( -e $confFile ) {
        UBOS::Utils::deleteFile( $confFile )
    }
}
1;
